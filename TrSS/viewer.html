<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta http-equiv='cache-control' content='no-cache'> 
	<meta http-equiv='expires' content='0'> 
	<meta http-equiv='pragma' content='no-cache'>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" type="text/css" href="../styles.css">
	<link rel="stylesheet" type="text/css" href="../Eulerian/styles.css">
	<title>TrSS Row Viewer</title>
</head>
<body>
	<h2>TrSS Row Viewer</h2>
	<div style="display: flex">
		<label for="sequenceInput">Sequence:</label>
		<input type="text" id="sequenceInput" oninput="draw()">
	</div>
	<div style="display: flex">
		<label for="expand"><button id="expandButton" onclick="onexpand()">Expand</button></label>
		<input type="text" id="expandInput" value="3" style="width:20px; text-align:center; margin-right: 5px" oninput="draw()">
	</div>
	<br>
	<div style="display: flex">
		<label for="textHeight">Text Height:</label>
		<input type="range" id="textHeight" min="12" max="64" value="20" oninput="draw()">
		<label for="lineSpacing">Line Spacing:</label>
		<input type="range" id="lineSpacing" min="0" max="20" value="4" oninput="draw()">
	</div>
	<div style="display: flex">
		<label for="rowWidth">Row Width:</label>
		<input type="range" id="rowWidth" min="0" max="200" value="20" oninput="draw()">
		<label for="rowHeight">Row Height:</label>
		<input type="range" id="rowHeight" min="0" max="200" value="20" oninput="draw()">
	</div>
	<br>
	<canvas id="canvas" style="border:2px solid #aaa;"></canvas>
	<br>
	<canvas id="canvas2" style="border:2px solid #aaa;"></canvas>
	<h3 id="matrix"></h3>
	<h3 id="matrix2"></h3>

	<script src="notation.js"></script>
	<script src="../Eulerian/mountain.js"></script>
	<script>
		let config = {
			PADDING: 10,
			hideVertical: true
		};
		
		let canvas = document.getElementById("canvas");
		let canvas2 = document.getElementById("canvas2");

		let textInput = document.getElementById("sequenceInput");
		let rowWidthInput = document.getElementById("rowWidth");
		let rowHeightInput = document.getElementById("rowHeight");
		let textHeightInput = document.getElementById("textHeight");
		let lineSpacingInput = document.getElementById("lineSpacing");
		let expandInput = document.getElementById("expandInput");
		textInput.value = "0,1,3,5";
		draw();

		function updateConfig() {
			config.rowWidth = parseInt(rowWidthInput.value);
			config.rowHeight = parseInt(rowHeightInput.value);
			config.textHeight = parseInt(textHeightInput.value);
			config.lineSpace = parseInt(lineSpacingInput.value);
			rowWidthInput.previousElementSibling.innerText = `Row Width: ${config.rowWidth}`;
			rowHeightInput.previousElementSibling.innerText = `Row Height: ${config.rowHeight}`;
			textHeightInput.previousElementSibling.innerText = `Text Height: ${config.textHeight}`;
			lineSpacingInput.previousElementSibling.innerText = `Line Spacing: ${config.lineSpace}`;
		}

		expandInput.addEventListener("keyup", ({key}) => {
			if (key == "Enter") {
				onexpand();
			}
		});

		function getSequence() {
			let inputText = textInput.value;
			if (inputText.length == 0) inputText = "0";
			return JSON.parse("["+inputText.match(/[0-9,]*[0-9]/)+"]");
		}

		function sequenceToRow(sequence) {
			let row = sequence.map((v, i) => {
				return {value: v, position: i, parentIndex: sequence.findLastIndex((x, j) => x < v && j < i)};
			});
			row.forEach((term, i) => {
				let numAncestors = 0;
				let current = i;
				while (true) {
					current = row[current].parentIndex;
					if (current == -1) break;
					numAncestors++;
				}
				term.numAncestors = numAncestors;
				if (term.parentIndex == -1) {
					term.rootIndex = -1;
				} else {
					let root = i;
					let diff = term.value - row[term.parentIndex].value;
					for (let j = 0; j < diff; j++) {
						root = row[root].parentIndex;
						if (row[root].value == 0) break;
					}
					term.rootIndex = root;
				}
			});
			return row;
		}

		function calcMountain(sequence) {
			let row0 = sequenceToRow(sequence);
			let row1 = [];
			row0.forEach((term, i) => {
				if (term.parentIndex == -1) return;
				let diff = term.value - row0[term.parentIndex].value;
				row1.push({
					value: diff - term.numAncestors,
					diff: diff,
					position: i,
					parentIndex: -1
				});
			});
			row0.forEach(term => {
				term.parentOverride = term.rootIndex;
			});
			row1.forEach(term => {
				if (term.value < 0) {
					term.textOverride = term.diff,
					term.colorOverride = "#2af";
				}
			});
			return [row0, row1];
		}

		function onexpand() {
			let sequence = getSequence();
			let n = parseInt(expandInput.value) || 0;
			let array = notation.expand(sequence, n).slice(0,1000);
			textInput.value = array.join(",");
			draw();
		}

		function toMatrixString(mountain) {
			let matrix = mountain[0].map((v, i) => {
				let diff = v.parentIndex == -1 ? v.value : v.value - mountain[0][v.parentIndex].value;
				return [v.numAncestors, diff];
			});
			return matrix.map(v => `(${v[0]},${v[1]})`).join("");
		}

		function draw() {
			updateConfig();
			let sequence = getSequence();
			let mountain = calcMountain(sequence);
			drawMountain(canvas, config, mountain);
			let n = parseInt(expandInput.value) || 0;
			let mountain2 = calcMountain(flatten(notation.expand(sequence, n)));
			drawMountain(canvas2, config, mountain2);
			document.getElementById("matrix").innerText = toMatrixString(mountain);
			document.getElementById("matrix2").innerText = toMatrixString(mountain2);
		}
	</script>

	<div id="footer">
		<a href="../TrSS">Explorer</a> | 
		<a href="../">Index</a>
	</div>
</body>
</html>